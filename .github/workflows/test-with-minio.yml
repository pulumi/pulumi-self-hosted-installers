permissions: write-all # Equivalent to default permissions plus id-token: write
env:
  ESC_ACTION_OIDC_AUTH: true
  ESC_ACTION_OIDC_ORGANIZATION: pulumi
  ESC_ACTION_OIDC_REQUESTED_TOKEN_TYPE: urn:pulumi:token-type:access_token:organization
  ESC_ACTION_ENVIRONMENT: github-secrets/pulumi-pulumi-self-hosted-installers
  ESC_ACTION_EXPORT_ENVIRONMENT_VARIABLES: false
# workflow_dispatch allows for manual triggering from the GitHub Actions UI, as well
# as the API. repository_dispatch allows us to trigger multiple workflows that
# match on an event_type parameter when triggered via an API call.
# https://docs.github.com/en/actions/reference/events-that-trigger-workflows
on:
  pull_request: null
  workflow_dispatch: null
  repository_dispatch:
    types: [integration_tests]

name: Test Minio as object storage

jobs:
  minio-test:

    runs-on: ubuntu-latest
    env:
      # The fake access keys used to configure the Minio container.
      # We will use these keys as the AWS access keys so that the
      # Pulumi service can connect to the Minio storage service.
      MINIO_ROOT_USER: "minio-access-key"
      MINIO_ROOT_PASSWORD: "minio-secret-key"
      MINIO_HOST: "minio:9000"
      MINIO_BUCKET_NAME: "pulumi-checkpoints"
      MINIO_PP_BUCKET_NAME: "pulumi-policy-packs"
      ESC_ACTION_EXPORT_ENVIRONMENT_VARIABLES: PULUMI_LICENSE_KEY

    steps:
      - name: Fetch secrets from ESC
        id: esc-secrets
        uses: pulumi/esc-action@cf5b30703ffd5ad60cc3a880c09b3a9592b9372d # v1
      - name: Set env vars
        run: |
          # There doesn't seem to be a way to map environment variables into other enviroments
          # when these are also defined in the same place as the ones they depend on.
          # So set those env vars using:
          # https://docs.github.com/en/actions/reference/workflow-commands-for-github-actions#setting-an-environment-variable

          # The only AWS resource the service will access is the Minio container
          # so we map its keys as the AWS keys for the service.
          echo "AWS_REGION=us-west-2" >> $GITHUB_ENV
          echo "AWS_ACCESS_KEY_ID=${MINIO_ROOT_USER}" >> $GITHUB_ENV
          echo "AWS_SECRET_ACCESS_KEY=${MINIO_ROOT_PASSWORD}" >> $GITHUB_ENV

          checkpoint_endpoint="s3://${MINIO_BUCKET_NAME}?endpoint=${MINIO_HOST}&disableSSL=true&s3ForcePathStyle=true"
          pp_endpoint="s3://${MINIO_PP_BUCKET_NAME}?endpoint=${MINIO_HOST}&disableSSL=true&s3ForcePathStyle=true"
          echo "PULUMI_CHECKPOINT_BLOB_STORAGE_ENDPOINT=${checkpoint_endpoint}" >> $GITHUB_ENV
          echo "PULUMI_POLICY_PACK_BLOB_STORAGE_ENDPOINT=${pp_endpoint}" >> $GITHUB_ENV

      - uses: actions/setup-go@d35c59abb061a4a6fb18e82ac0862c26744d6ab5 # v5
        with:
          go-version: 1.24

      - uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4
        with:
          node-version: '22'

      - name: Checkout pulumi/pulumi-self-hosted-installers
        uses: actions/checkout@ff7abcd0c3c05ccf6adc123a8cd1fd4fb30fb493 # v4

      - name: Login to Docker Hub as pulumi-bot
        uses: docker/login-action@184bdaa0721073962dff0199f1fb9940f07167d1 # v3
        with:
          username: ${{ steps.esc-secrets.outputs.DOCKERHUB_USERNAME }}
          password: ${{ steps.esc-secrets.outputs.DOCKERHUB_PASSWORD }}

      - name: Run Minio
        run: |
          set -x  # Enable command tracing

          echo "===== Creating Docker volume for MinIO ====="
          docker volume create minio-data

          echo "===== Starting MinIO container ====="
          docker run -d --name minio \
              --publish 9000:9000 \
              --volume minio-data:/data \
              --env MINIO_ROOT_USER="${MINIO_ROOT_USER}" \
              --env MINIO_ROOT_PASSWORD="${MINIO_ROOT_PASSWORD}" \
              cgr.dev/chainguard/minio:latest \
              server /data

          DOCKER_EXIT=$?
          echo "Docker run exit code: $DOCKER_EXIT"

          sleep 5

          echo "===== Container Status ====="
          docker ps -a

          echo "===== Container Inspection ====="
          docker inspect minio | jq '.[0] | {State, Config: {Env, Cmd}, NetworkSettings: {Ports}}'

          echo "===== Full MinIO Logs ====="
          docker logs minio 2>&1

          echo "===== Network Information ====="
          netstat -tlnp | grep 9000 || echo "No process listening on port 9000"

          echo "===== Port Test with nc ====="
          nc -zv 127.0.0.1 9000 2>&1 || echo "nc failed to connect"

          echo "===== Port Test with telnet ====="
          timeout 2 telnet 127.0.0.1 9000 2>&1 || echo "telnet failed"

          echo "===== Testing Raw HTTP Connection ====="
          (echo -e "GET / HTTP/1.0\r\n\r\n"; sleep 1) | nc 127.0.0.1 9000 2>&1 || echo "Raw HTTP test failed"

          echo "===== Waiting for MinIO with Health Check ====="
          READY=false
          for i in {1..30}; do
            echo "Attempt $i/30: Checking MinIO health..."

            # Try health endpoint
            if curl -v http://127.0.0.1:9000/minio/health/live 2>&1; then
              echo "âœ“ MinIO health check passed!"
              READY=true
              break
            fi

            # Also try root endpoint
            echo "Trying root endpoint..."
            curl -v http://127.0.0.1:9000/ 2>&1 || true

            sleep 2
          done

          if [ "$READY" = false ]; then
            echo "ERROR: MinIO never became ready after 60 seconds"
            echo "===== Final Container Status ====="
            docker ps -a
            echo "===== Final MinIO Logs ====="
            docker logs minio 2>&1
            exit 1
          fi

          echo "127.0.0.1 minio" | sudo tee -a /etc/hosts

      - name: Create Minio buckets
        run: |
          set -x  # Enable command tracing

          echo "===== Downloading mc client ====="
          wget -q https://dl.min.io/client/mc/release/linux-amd64/mc
          chmod +x mc
          ./mc --version

          echo "===== Pre-flight checks ====="
          echo "Testing connection to MinIO..."
          curl -v http://127.0.0.1:9000/ 2>&1 || echo "Curl to root failed"

          echo "===== Creating mc alias ====="
          # Create a new alias called minio for our Minio container.
          # Use 127.0.0.1:9000 (IPv4) since MinIO is published to the host's port 9000
          ./mc alias set minio "http://127.0.0.1:9000" "${MINIO_ROOT_USER}" "${MINIO_ROOT_PASSWORD}" --api S3v4 2>&1 || {
            echo "ERROR: Failed to create mc alias"
            echo "===== MinIO container status ====="
            docker ps -a | grep minio
            echo "===== MinIO logs ====="
            docker logs minio 2>&1
            exit 1
          }

          echo "===== Verifying alias ====="
          ./mc alias list

          echo "===== Creating buckets ====="
          ./mc mb "minio/${MINIO_BUCKET_NAME}" 2>&1
          ./mc mb "minio/${MINIO_PP_BUCKET_NAME}" 2>&1

          echo "===== Listing buckets ====="
          ./mc ls minio/

      - name: Configure Minio network
        run: |
          # Connect Minio to the pulumi-self-hosted-installers docker network.
          docker network create pulumi-self-hosted-installers
          docker network connect pulumi-self-hosted-installers minio

      - uses: ./.github/actions/run-self-hosted
        timeout-minutes: 5
        with:
          compose-args: '-f ./quickstart-docker-compose/all-in-one/docker-compose.yml -f ./quickstart-docker-compose/all-in-one/docker-compose.edge.yml'

      - name: Run integration tests
        run: go test ./quickstart-docker-compose/tests/... -v --tags=minio

      - name: Upload service log as artifact
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        if: ${{ always() }}
        with:
          name: service-log
          path: ${{ env.SERVICE_LOG }}
          overwrite: true
